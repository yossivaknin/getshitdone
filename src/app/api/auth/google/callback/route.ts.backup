import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const code = searchParams.get('code');
  const error = searchParams.get('error');

  // Check if this is a Capacitor JSON request
  const isCapacitorJson = request.nextUrl.searchParams.get('format') === 'json' || 
                          request.nextUrl.searchParams.get('capacitor') === 'true';
  console.log('[OAuth Callback] Request received:', {
    hasCode: !!code,
    hasError: !!error,
    isCapacitorJson: isCapacitorJson,
    format: request.nextUrl.searchParams.get('format'),
    capacitor: request.nextUrl.searchParams.get('capacitor'),
    userAgent: request.headers.get('user-agent')?.substring(0, 50),
    url: request.url.substring(0, 100)
  });
  
  if (error) {
    if (isCapacitorJson) {
      return NextResponse.json({ 
        success: false, 
        error: error 
      }, { status: 400 });
    }
    // For web, use a known good base URL instead of request.url
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://192.168.1.70:3000';
    return NextResponse.redirect(
      new URL(`/settings?error=${encodeURIComponent(error)}`, baseUrl)
    );
  }

  if (!code) {
    if (isCapacitorJson) {
      return NextResponse.json({ 
        success: false, 
        error: 'no_code' 
      }, { status: 400 });
    }
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://192.168.1.70:3000';
    return NextResponse.redirect(new URL('/settings?error=no_code', baseUrl));
  }

  try {
    // Detect if this is from Capacitor by checking the User-Agent or origin
    const userAgent = request.headers.get('user-agent') || '';
    const isCapacitor = userAgent.includes('Capacitor') || 
                        request.nextUrl.searchParams.get('capacitor') === 'true';
    
    // Use iOS client ID for Capacitor, web client ID for browser
    // Both client IDs can share the same client secret
    const clientId = isCapacitor
      ? (process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID_IOS || process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID)
      : (process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID_WEB || process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID);
    const clientSecret = process.env.GOOGLE_CLIENT_SECRET;
    
    // The redirect URI must match EXACTLY what was sent in the authorization request
    // For iOS native apps, we use custom URL scheme
    // For web apps, we use HTTPS URLs
    let redirectUri: string;
    
    if (isCapacitor) {
      // For Capacitor (iOS native app), use Google's reversed client ID format
      // Extract client ID and build reversed format
      const clientIdParts = clientId?.split('.apps.googleusercontent.com')[0];
      const reversedClientId = clientIdParts ? `com.googleusercontent.apps.${clientIdParts}` : 'com.sitrep.app';
      redirectUri = `${reversedClientId}:/oauth2redirect`;
    } else {
      // For web, use production HTTPS URL (required for sensitive scopes)
      const productionUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://usesitrep.com';
      redirectUri = `${productionUrl}/api/auth/google/callback`;
    }
    
    console.log('[OAuth Callback] Is Capacitor:', isCapacitor);
    console.log('[OAuth Callback] Client ID type:', isCapacitor ? 'iOS' : 'Web');
    console.log('[OAuth Callback] Redirect URI:', redirectUri);
    console.log('[OAuth Callback] Request origin:', request.nextUrl.origin);
    console.log('[OAuth Callback] NEXT_PUBLIC_APP_URL:', process.env.NEXT_PUBLIC_APP_URL);
    
    // DEBUG: Validate all parameters before making token request
    console.log('[OAuth Callback] DEBUG Token Exchange Parameters:');
    console.log('[OAuth Callback] - Code:', code ? code.substring(0, 30) + '...' : 'MISSING');
    console.log('[OAuth Callback] - Code length:', code?.length || 0);
    console.log('[OAuth Callback] - Client ID:', clientId ? clientId.substring(0, 30) + '...' : 'MISSING');
    console.log('[OAuth Callback] - Client Secret:', clientSecret ? '***SET***' : 'MISSING');
    console.log('[OAuth Callback] - Redirect URI:', redirectUri);
    console.log('[OAuth Callback] - Grant Type: authorization_code');
    
    // Validate required parameters
    if (!code || code.trim() === '') {
      console.error('[OAuth Callback] ❌ Authorization code is missing or empty');
      // TODO: Ensure this redirect checks isCapacitorJson
      if (isCapacitorJson) {
        return NextResponse.json({ success: false, error: 'missing_code' }, { status: 400 });
      }
      const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://192.168.1.70:3000';
      return NextResponse.redirect(
        new URL('/settings?error=missing_code', baseUrl)
      );
    }
    
    if (!clientId || !clientSecret) {
      console.error('[OAuth Callback] ❌ Client ID or Secret is missing');
      // TODO: Ensure this redirect checks isCapacitorJson
      const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001';
      return NextResponse.redirect(
        new URL('/settings?error=missing_credentials', baseUrl)
      );
    }
    
    if (!redirectUri) {
      console.error('[OAuth Callback] ❌ Redirect URI is missing');
      // TODO: Ensure this redirect checks isCapacitorJson
      const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001';
      return NextResponse.redirect(
        new URL('/settings?error=missing_redirect_uri', baseUrl)
      );

    // Validate required OAuth credentials
    if (!clientId || !clientSecret) {
      console.error('[OAuth Callback] Missing OAuth credentials:', {
        hasClientId: !!clientId,
        hasClientSecret: !!clientSecret,
      });
      const isCapacitorJson = request.nextUrl.searchParams.get('format') === 'json' || 
                              request.nextUrl.searchParams.get('capacitor') === 'true';
      if (isCapacitorJson) {
        return NextResponse.json({ 
          success: false, 
          error: 'oauth_config_error'
        }, { status: 500 });
      }
      const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001';
      return NextResponse.redirect(
        new URL('/settings?error=oauth_config_error', baseUrl)
      );
    }

    // Construct token exchange request body
    const tokenRequestBody = new URLSearchParams({
      code: code.trim(),
      client_id: clientId,
      client_secret: clientSecret,
      redirect_uri: redirectUri,
      grant_type: 'authorization_code',
    });
    
    console.log('[OAuth Callback] Token request body (without secret):', 
      tokenRequestBody.toString().replace(/client_secret=[^&]+/, 'client_secret=***'));
    
    const tokenEndpoint = 'https://oauth2.googleapis.com/token';
    console.log('[OAuth Callback] Token endpoint:', tokenEndpoint);
    
    const tokenResponse = await fetch(tokenEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: tokenRequestBody.toString(),
    });

    if (!tokenResponse.ok) {
      const errorText = await tokenResponse.text();
      console.error('[OAuth Callback] Token exchange failed:', errorText);
      throw new Error(`Failed to exchange code for tokens: ${errorText}`);
    }

    const tokens = await tokenResponse.json();
    
    console.log('[OAuth Callback] Token response:', {
      hasAccessToken: !!tokens.access_token,
      hasRefreshToken: !!tokens.refresh_token,
      accessTokenLength: tokens.access_token?.length || 0,
      refreshTokenLength: tokens.refresh_token?.length || 0,
      tokenType: tokens.token_type,
      expiresIn: tokens.expires_in,
      scope: tokens.scope
    });

    // Validate that we have an access token
    if (!tokens.access_token) {
      console.error('[OAuth Callback] ❌ No access_token in response!');
      console.error('[OAuth Callback] Response:', JSON.stringify(tokens, null, 2));
      // TODO: Ensure this redirect checks isCapacitorJson
        const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3001';
      return NextResponse.redirect(
        new URL('/settings?error=no_access_token', baseUrl)
      );
    }

    // Store tokens (in production, store in database)
    // For now, we'll pass them via URL params to the settings page
    // In production, use secure httpOnly cookies or database storage
    
    // If this is from Capacitor, check if it's a direct API call (HTTP plugin) or web redirect
    if (isCapacitor) {
      // Check if this is a direct API call (from Capacitor HTTP plugin) or a web redirect
      const isDirectApiCall = request.headers.get('accept')?.includes('application/json') ||
                              request.nextUrl.searchParams.get('format') === 'json';

      if (isDirectApiCall) {
        // Return JSON for Capacitor HTTP plugin to consume directly
        console.log('[OAuth Callback] Returning JSON tokens for Capacitor HTTP plugin');
        return NextResponse.json({
          success: true,
          token: tokens.access_token,
          refresh: tokens.refresh_token,
          expires_in: tokens.expires_in,
        });
      }

      // Otherwise, redirect to the app using custom URL scheme with tokens via HTML page
      // Build the URL manually since custom schemes don't work with URL constructor
      const params = new URLSearchParams();
      params.set('connected', 'true');
      params.set('token', tokens.access_token);
      if (tokens.refresh_token) {
        params.set('refresh', tokens.refresh_token);
      }
      
      // Use Google's reversed client ID format for the redirect
      // Extract client ID and build reversed format
      const clientIdParts = clientId?.split('.apps.googleusercontent.com')[0];
      const reversedClientId = clientIdParts ? `com.googleusercontent.apps.${clientIdParts}` : 'com.sitrep.app';
      const appUrlString = `${reversedClientId}:/oauth2redirect?${params.toString()}`;
      
      console.log('[OAuth Callback] Redirecting to Capacitor app with tokens (HTML redirect)');
      console.log('[OAuth Callback] App URL:', appUrlString);
      
      // Return HTML that redirects to the app with clear instructions
      return new NextResponse(
        `<!DOCTYPE html>
        <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Success! Return to App</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background: linear-gradient(135deg, #0F0F0F 0%, #1a1a2e 100%);
                color: #fff;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                text-align: center;
                padding: 2rem;
              }
              .container {
                max-width: 400px;
                width: 100%;
              }
              .success-icon {
                width: 80px;
                height: 80px;
                margin: 0 auto 2rem;
                background: #10b981;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 40px;
                animation: scaleIn 0.5s ease-out;
              }
              @keyframes scaleIn {
                0% { transform: scale(0); opacity: 0; }
                100% { transform: scale(1); opacity: 1; }
              }
              h1 {
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 1rem;
                color: #10b981;
              }
              p {
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 2rem;
                opacity: 0.9;
              }
              .button {
                display: inline-block;
                padding: 14px 28px;
                background: #10b981;
                color: white;
                text-decoration: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 16px;
                transition: all 0.2s;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
              }
              .button:hover {
                background: #059669;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
              }
              .button:active {
                transform: translateY(0);
              }
            </style>
            <script>
              (function() {
                const appUrl = '${appUrlString.replace(/'/g, "\\'")}';
                
                console.log('[OAuth Redirect] Attempting to open app with URL:', appUrl);
                console.log('[OAuth Redirect] Current location:', window.location.href);
                
                // Try to open app immediately with multiple methods
                function openApp() {
                  try {
                    console.log('[OAuth Redirect] Opening app via window.location');
                    // Method 1: window.location (most reliable)
                    window.location.href = appUrl;
                    
                    // Method 2: location.replace (fallback)
                    setTimeout(function() {
                      console.log('[OAuth Redirect] Trying location.replace');
                      window.location.replace(appUrl);
                    }, 100);
                    
                    // Method 3: Create invisible link and click (fallback)
                    setTimeout(function() {
                      console.log('[OAuth Redirect] Trying link click');
                      const link = document.createElement('a');
                      link.href = appUrl;
                      link.style.display = 'none';
                      document.body.appendChild(link);
                      link.click();
                      setTimeout(function() {
                        if (link.parentNode) {
                          document.body.removeChild(link);
                        }
                      }, 100);
                    }, 200);
                  } catch (e) {
                    console.error('[OAuth Redirect] Error opening app:', e);
                  }
                }
                
                // Try immediately (no waiting)
                openApp();
                
                // Also try on every possible event
                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', openApp);
                } else {
                  openApp();
                }
                
                window.addEventListener('load', function() {
                  setTimeout(openApp, 50);
                });
                
                // Make the button also open the app
                document.addEventListener('DOMContentLoaded', function() {
                  const button = document.querySelector('.button');
                  if (button) {
                    button.href = appUrl;
                    button.addEventListener('click', function(e) {
                      e.preventDefault();
                      console.log('[OAuth Redirect] Button clicked, opening app');
                      openApp();
                    });
                  }
                });
              })();
            </script>
          </head>
          <body>
            <div class="container">
              <div class="success-icon">✓</div>
              <h1>Successfully Connected!</h1>
              <p>Your Google Calendar has been connected. Please return to the SITREP app to continue.</p>
              <a href="${appUrlString}" class="button">Open SITREP App</a>
              <p style="font-size: 12px; opacity: 0.6; margin-top: 1rem; word-break: break-all;">
                URL: ${appUrlString.substring(0, 80)}...
              </p>
            </div>
          </body>
        </html>`,
        {
          status: 200,
          headers: {
            'Content-Type': 'text/html',
          },
        }
      );
    }
    
    // For web, redirect normally
    // For Capacitor, we already returned JSON above, so this is only for web
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://192.168.1.70:3000';
    const redirectUrl = new URL('/settings', baseUrl);
    redirectUrl.searchParams.set('connected', 'true');
    redirectUrl.searchParams.set('token', tokens.access_token);
    if (tokens.refresh_token) {
      redirectUrl.searchParams.set('refresh', tokens.refresh_token);
    }
    
    console.log('[OAuth Callback] Redirecting to settings with tokens');
    
    // TODO: Ensure this redirect checks isCapacitorJson
    return NextResponse.redirect(redirectUrl);
  }
  catch (error) {
    console.error('OAuth callback error:', error);
    // TODO: Ensure this redirect checks isCapacitorJson
    const isCapacitorJson = request.nextUrl.searchParams.get('format') === 'json' || 
                            request.nextUrl.searchParams.get('capacitor') === 'true';
    if (isCapacitorJson) {
      return NextResponse.json({ 
        success: false, 
        error: 'oauth_failed'
      }, { status: 500 });
    }
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://192.168.1.70:3000';
    return NextResponse.redirect(
      new URL('/settings?error=oauth_failed', baseUrl)
    );
  }
}

}
